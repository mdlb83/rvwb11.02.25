/**
 * Script to generate bundled photo asset mapping with actual require() calls
 * This creates a mapping file that maps localPath to require() calls
 * Run this script whenever new photos are added to generate the mapping
 * 
 * Only bundles the first 2 photos per campground to reduce bundle size.
 * Additional photos will be loaded on-demand via API.
 */

const fs = require('fs');
const path = require('path');

// Maximum number of photos to bundle per campground
// Both iOS and Android: 2 photos per campground to reduce bundle size
const MAX_BUNDLED_PHOTOS_PER_CAMPGROUND = 2;

// Load the Google Maps data JSON
const googleMapsDataPath = path.join(__dirname, '../data/google-maps-data.json');
const googleMapsData = JSON.parse(fs.readFileSync(googleMapsDataPath, 'utf8'));

// Collect all photo localPaths and verify they exist on disk
// Only include first MAX_BUNDLED_PHOTOS_PER_CAMPGROUND photos per campground
const photoMapping = {};
let photoCount = 0;
let missingCount = 0;
let skippedCount = 0;

Object.values(googleMapsData.entries).forEach((entry) => {
  if (entry.photos && Array.isArray(entry.photos)) {
    // Only process first MAX_BUNDLED_PHOTOS_PER_CAMPGROUND photos
    const photosToBundle = entry.photos.slice(0, MAX_BUNDLED_PHOTOS_PER_CAMPGROUND);
    
    photosToBundle.forEach((photo, index) => {
      if (photo.localPath) {
        // Check if the file actually exists on disk
        const fullPath = path.join(__dirname, '..', photo.localPath);
        if (fs.existsSync(fullPath)) {
          // Convert localPath to a require path
          // localPath: "assets/google-maps-photos/campground-id/photo-0.jpg"
          // require path: require('../assets/google-maps-photos/campground-id/photo-0.jpg')
          const requirePath = `../${photo.localPath}`;
          photoMapping[photo.localPath] = requirePath;
          photoCount++;
        } else {
          missingCount++;
          if (missingCount <= 10) {
            console.warn(`‚ö†Ô∏è  Asset not found: ${photo.localPath}`);
          }
        }
      }
    });
    
    // Count skipped photos (beyond first 4)
    if (entry.photos.length > MAX_BUNDLED_PHOTOS_PER_CAMPGROUND) {
      skippedCount += entry.photos.length - MAX_BUNDLED_PHOTOS_PER_CAMPGROUND;
    }
  }
});

if (missingCount > 10) {
  console.warn(`‚ö†Ô∏è  ... and ${missingCount - 10} more assets not found`);
}

// Generate the mapping file content with actual require() calls
// This creates a huge mapping object with static require() references
let requireMappings = 'export const BUNDLED_PHOTO_ASSETS: { [localPath: string]: any } = {\n';
let mappingCount = 0;

Object.entries(photoMapping).forEach(([localPath, requirePath]) => {
  // Create a require() call for each asset
  // Note: This will create a very large file, but it's the only way to use bundled assets
  requireMappings += `  "${localPath}": require("${requirePath}"),\n`;
  mappingCount++;
  if (mappingCount % 500 === 0) {
    console.log(`Generated ${mappingCount} mappings...`);
  }
});

requireMappings += '};\n';

const mappingContent = `/**
 * Auto-generated bundled photo asset mapping
 * DO NOT EDIT MANUALLY - This file is generated by scripts/generate-bundled-photo-mapping.js
 * 
 * Maps localPath from JSON to require() calls for bundled assets
 * Only includes first ${MAX_BUNDLED_PHOTOS_PER_CAMPGROUND} photos per campground to reduce bundle size.
 * Additional photos are loaded on-demand via Google Places API.
 * 
 * Total photos mapped: ${photoCount}
 */

import { Asset } from 'expo-asset';

${requireMappings}

/**
 * Check if a photo has a bundled asset available
 */
export function hasBundledAsset(localPath: string): boolean {
  return !!BUNDLED_PHOTO_ASSETS[localPath];
}

/**
 * Get bundled asset source for a localPath
 * Returns the require() result that can be used directly with Image component
 * Returns null if asset is not bundled
 */
export function getBundledPhotoSource(localPath: string): any {
  // Check if we have this asset in our mapping
  if (!BUNDLED_PHOTO_ASSETS[localPath]) {
    return null;
  }
  
  try {
    // Return the require() result directly - this can be used as Image source
    return BUNDLED_PHOTO_ASSETS[localPath];
  } catch (error) {
    console.warn('Failed to retrieve bundled asset source:', localPath, error);
    return null;
  }
}
`;

// Write the mapping file
const outputPath = path.join(__dirname, '../utils/bundledPhotoAssets.ts');
fs.writeFileSync(outputPath, mappingContent, 'utf8');

console.log(`‚úÖ Generated bundled photo mapping with ${photoCount} photos`);
console.log(`üì¶ Only bundled first ${MAX_BUNDLED_PHOTOS_PER_CAMPGROUND} photos per campground`);
if (skippedCount > 0) {
  console.log(`‚ÑπÔ∏è  ${skippedCount} additional photos will be loaded on-demand via API`);
}
if (missingCount > 0) {
  console.log(`‚ö†Ô∏è  ${missingCount} assets from JSON not found on disk (skipped)`);
}
console.log(`üìÅ Output: ${outputPath}`);
