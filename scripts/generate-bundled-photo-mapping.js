/**
 * Script to generate bundled photo asset mapping with actual require() calls
 * This creates a mapping file that maps localPath to require() calls
 * Run this script whenever new photos are added to generate the mapping
 * 
 * WARNING: This will generate a very large file (4000+ require() calls)
 */

const fs = require('fs');
const path = require('path');

// Load the Google Maps data JSON
const googleMapsDataPath = path.join(__dirname, '../data/google-maps-data.json');
const googleMapsData = JSON.parse(fs.readFileSync(googleMapsDataPath, 'utf8'));

// Collect all photo localPaths and verify they exist on disk
const photoMapping = {};
let photoCount = 0;
let missingCount = 0;

Object.values(googleMapsData.entries).forEach((entry) => {
  if (entry.photos && Array.isArray(entry.photos)) {
    entry.photos.forEach((photo) => {
      if (photo.localPath) {
        // Check if the file actually exists on disk
        const fullPath = path.join(__dirname, '..', photo.localPath);
        if (fs.existsSync(fullPath)) {
          // Convert localPath to a require path
          // localPath: "assets/google-maps-photos/campground-id/photo-0.jpg"
          // require path: require('../assets/google-maps-photos/campground-id/photo-0.jpg')
          const requirePath = `../${photo.localPath}`;
          photoMapping[photo.localPath] = requirePath;
          photoCount++;
        } else {
          missingCount++;
          if (missingCount <= 10) {
            console.warn(`‚ö†Ô∏è  Asset not found: ${photo.localPath}`);
          }
        }
      }
    });
  }
});

if (missingCount > 10) {
  console.warn(`‚ö†Ô∏è  ... and ${missingCount - 10} more assets not found`);
}

// Generate the mapping file content with actual require() calls
// This creates a huge mapping object with static require() references
let requireMappings = 'export const BUNDLED_PHOTO_ASSETS: { [localPath: string]: any } = {\n';
let mappingCount = 0;

Object.entries(photoMapping).forEach(([localPath, requirePath]) => {
  // Create a require() call for each asset
  // Note: This will create a very large file, but it's the only way to use bundled assets
  requireMappings += `  "${localPath}": require("${requirePath}"),\n`;
  mappingCount++;
  if (mappingCount % 500 === 0) {
    console.log(`Generated ${mappingCount} mappings...`);
  }
});

requireMappings += '};\n';

const mappingContent = `/**
 * Auto-generated bundled photo asset mapping
 * DO NOT EDIT MANUALLY - This file is generated by scripts/generate-bundled-photo-mapping.js
 * 
 * Maps localPath from JSON to require() calls for bundled assets
 * Total photos mapped: ${photoCount}
 * 
 * WARNING: This file is very large and contains ${photoCount} static require() calls.
 */

import { Asset } from 'expo-asset';

${requireMappings}

/**
 * Check if a photo has a bundled asset available
 */
export function hasBundledAsset(localPath: string): boolean {
  return !!BUNDLED_PHOTO_ASSETS[localPath];
}

/**
 * Get bundled asset source for a localPath
 * Returns the require() result that can be used directly with Image component
 * Returns null if asset is not bundled
 */
export function getBundledPhotoSource(localPath: string): any {
  // Check if we have this asset in our mapping
  if (!BUNDLED_PHOTO_ASSETS[localPath]) {
    return null;
  }
  
  try {
    // Return the require() result directly - this can be used as Image source
    return BUNDLED_PHOTO_ASSETS[localPath];
  } catch (error) {
    console.warn('Failed to retrieve bundled asset source:', localPath, error);
    return null;
  }
}
`;

// Write the mapping file
const outputPath = path.join(__dirname, '../utils/bundledPhotoAssets.ts');
fs.writeFileSync(outputPath, mappingContent, 'utf8');

console.log(`‚úÖ Generated bundled photo mapping with ${photoCount} photos`);
if (missingCount > 0) {
  console.log(`‚ö†Ô∏è  ${missingCount} assets from JSON not found on disk (skipped)`);
}
console.log(`üìÅ Output: ${outputPath}`);
console.log(`‚ö†Ô∏è  File size will be large due to ${photoCount} require() calls`);
